import React from 'react';
import { ethers } from "ethers";
import { useState, createContext, useContext } from 'react'
import './App.css';

const abi = [
  "constructor(address bonsaiRelay, bytes32 _fibImageId, uint256[2] _publicKey)",
  "function send(bool verify_result, address _to, uint256 value)",
  "function verifyAndSend(address _to, bytes auth_data, uint256 value)"
];

function App() {
  const [Provider, setProvider] = useState<ethers.BrowserProvider | null>(new ethers.BrowserProvider(window.ethereum));
  const [Signer, setSigner] = useState<ethers.JsonRpcSigner | null>(null);
  const [ContractAddress, setContractAddress] = useState<string | null>(null);

  const Connect = () => {
    if (Provider === null) {
      console.log('provider not found');
      return;
    }

    const signer = Provider.getSigner();
    signer.then((s) => {
      setSigner(s);
      console.log('signer',s);
    });
  }

  const CreateWallet = (pubkeyA: string, pubkeyB: string) => {
    const bytecode = "0x60c060405234801561001057600080fd5b5060405161085038038061085083398101604081905261002f916100d3565b6001600160a01b03831660805260a082905261004e600082600261006a565b5050600280546001600160a01b031916331790555061017c9050565b8260028101928215610098579160200282015b8281111561009857825182559160200191906001019061007d565b506100a49291506100a8565b5090565b5b808211156100a457600081556001016100a9565b634e487b7160e01b600052604160045260246000fd5b6000806000608084860312156100e857600080fd5b83516001600160a01b03811681146100ff57600080fd5b80935050602080850151925085605f86011261011a57600080fd5b604080519081016001600160401b038111828210171561013c5761013c6100bd565b60405280608087018881111561015157600080fd5b604088015b8181101561016d5780518352918401918401610156565b50505080925050509250925092565b60805160a05161068d6101c360003960008181608e01528181610151015261029501526000818161010d0152818161026601528181610350015261038d015261068d6000f3fe60806040526004361061004e5760003560e01c8063041507c51461005a57806313234edc1461007c5780638da5cb5b146100c3578063e70ffd4b146100fb578063f885dd8f1461012f57600080fd5b3661005557005b600080fd5b34801561006657600080fd5b5061007a61007536600461042d565b61014f565b005b34801561008857600080fd5b506100b07f000000000000000000000000000000000000000000000000000000000000000081565b6040519081526020015b60405180910390f35b3480156100cf57600080fd5b506002546100e3906001600160a01b031681565b6040516001600160a01b0390911681526020016100ba565b34801561010757600080fd5b506100e37f000000000000000000000000000000000000000000000000000000000000000081565b34801561013b57600080fd5b5061007a61014a366004610473565b610264565b7f0000000000000000000000000000000000000000000000000000000000000000610178610345565b610181816103c5565b836101c05760405162461bcd60e51b815260206004820152600a60248201526914da59c819985a5b195960b21b60448201526064015b60405180910390fd5b600080846001600160a01b03168460405160006040518083038185875af1925050503d806000811461020e576040519150601f19603f3d011682016040523d82523d6000602084013e610213565b606091505b50915091508161025c5760405162461bcd60e51b81526020600482015260146024820152732330b4b632b2103a379039b2b7321022ba3432b960611b60448201526064016101b7565b505050505050565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b031663e80802a27f00000000000000000000000000000000000000000000000000000000000000006000878787876040516020016102ce9594939291906104fe565b60408051601f19818403018152908290526001600160e01b031960e085901b16825261030d9291309063041507c560e01b90620186a090600401610558565b600060405180830381600087803b15801561032757600080fd5b505af115801561033b573d6000803e3d6000fd5b5050505050505050565b336001600160a01b037f00000000000000000000000000000000000000000000000000000000000000001681146103c25760405163432e033760e11b81526001600160a01b037f000000000000000000000000000000000000000000000000000000000000000081166004830152821660248201526044016101b7565b50565b600080366103d46020826105e8565b6103df92829061060f565b6103e891610639565b905080821461041457604051630be5472b60e41b815260048101839052602481018290526044016101b7565b5050565b6001600160a01b03811681146103c257600080fd5b60008060006060848603121561044257600080fd5b8335801515811461045257600080fd5b9250602084013561046281610418565b929592945050506040919091013590565b6000806000806060858703121561048957600080fd5b843561049481610418565b9350602085013567ffffffffffffffff808211156104b157600080fd5b818701915087601f8301126104c557600080fd5b8135818111156104d457600080fd5b8860208285010111156104e657600080fd5b95986020929092019750949560400135945092505050565b60008187825b6002811015610523578154835260209092019160019182019101610504565b5050506bffffffffffffffffffffffff198660601b166040830152838560548401375060549201918201526074019392505050565b8581526000602060a08184015286518060a085015260005b8181101561058c5788810183015185820160c001528201610570565b50600060c08286018101919091526001600160a01b03881660408601526001600160e01b031987166060860152601f909101601f191684010191506105ce9050565b67ffffffffffffffff831660808301529695505050505050565b8181038181111561060957634e487b7160e01b600052601160045260246000fd5b92915050565b6000808585111561061f57600080fd5b8386111561062c57600080fd5b5050820193919092039150565b8035602083101561060957600019602084900360031b1b169291505056fea2646970667358221220d6aeea197de63bc87578f377353867b4dda6091911efd5432a713c728fb832ad64736f6c63430008140033";
    const factory = new ethers.ContractFactory(abi, bytecode, Signer);
    // TODO: this image id is for fibonacci
    const imageId = "0xc60c048c0aec1cccae8c9ac3852123040c4f36969e8ac362633a7dfd8b18f7a7";
    const relayAddress = "0x5fbdb2315678afecb367f032d93f642f64180aa3";

    factory.deploy(relayAddress, imageId, [pubkeyA, pubkeyB]).then((contract) => {
      console.log("deploy started...");
      return contract.waitForDeployment();
    }).then((result) => {
      console.log("deploy completed. Getting address...");
      return result.getAddress();
    }).then((address) => {
      setContractAddress(address);
      console.log(address);
    });
  }

  // Calls request function for our contract;
  const Send = () => {
    if (Signer === null) {
      console.log('signer not found');
      return;
    }
    if (ContractAddress === null) {
      console.log('contract address not found');
      return;
    }

    // read & write
    const contract = new ethers.Contract(ContractAddress, abi, Signer);

    // TODO: use publickey, signature, message
    const to = "0x23618e81E3f5cdF7f54C3d65f7FBc0aBf5B21E8f";
    const auth_data = "0xaf2bdbe1aa9b6ec1e2ade1d694f41fc71a831d0268e9891562113d8a62add1bfEFD48B2AACB6A8FD1140DD9CD45E81D69D2C877B56AAF991C34D0EA84EAF3716F7CB1C942D657C41D436C7A1B6E29F65F3E900DBB9AFF4064DC4AB2F843ACDA8";

    const value = 1;
    contract.verifyAndSend(to, auth_data, value)
      .then((f) => {
        console.log("successfully send transaction",f);
      })
  }

  const Check = () => {
    if (ContractAddress === null) {
      console.log('contract address not found');
      return;
    }
    // readonly
    const contract = new ethers.Contract(ContractAddress, abi, Provider);

    // TODO: check the result of money transfer
    if (Provider === null) { return }
    Provider.getBalance(ContractAddress)
      .then((result) => {
        console.log("balance of wallet contract: ", result);
      }).catch((err) => {
        console.log("error: ", err);
      })
  }

  return (
    <div className="App">
      <div style={{ padding: "2rem" }}>
          <h2>0. Run avail, deploy relay contract, launch relay server.</h2>
      </div>
      <div className="ConnectWallet" style={{ padding: "2rem" }}>
          <h2>1. connect wallet</h2>
          <button onClick={Connect}>connect</button>
          <div>{Signer === null ? 'not connected' : 'connected ' + Signer.address}</div>
      </div>
      <div className="CreateWallet" style={{ padding: "2rem" } }>
        <h2>2. Create Wallet (only first)</h2>
        <button onClick={() => { CreateWallet("0x60FED4BA255A9D31C961EB74C6356D68C049B8923B61FA6CE669622E60F29FB6","0x7903FE1008B8BC99A41AE9E95628BC64F2F1B20C2D7E9F5177A3C294D4462299") }}>create</button>
        <span>contractAddress { ContractAddress ? ContractAddress : 'not found' }</span>
        <span>(check console log for result.)</span>
      </div>
      <div className="Send" style={{ padding: "2rem"} }>
          <h2>3. Send money from contract</h2>
          <button onClick={Send}>Submit send request</button>
          <span>(check console log for result. wait for 1 conf on blockchain.)</span>
      </div>
      <div className="Check" style={{ padding: "2rem"} }>
          <h2>4. Check the balance</h2>
          <button onClick={Check}>Check</button>
          <span>(check console log for result.)</span>
      </div>
    </div>
  );
}

export default App;
